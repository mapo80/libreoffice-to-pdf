name: Dep Ladder Verify (macOS serial)

on:
  workflow_dispatch:
    inputs:
      run_linux_validate:
        description: "Run Linux Docker validation after each accepted macOS step"
        required: false
        default: "0"
      nproc:
        description: "Parallel jobs for local make inside each build step"
        required: false
        default: "8"
      required_step:
        description: "Fail workflow if best accepted step is below this value"
        required: false
        default: "0"

jobs:
  dep_ladder:
    runs-on: macos-14
    timeout-minutes: 1440

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install autoconf automake libtool pkg-config ccache \
                       nasm flex bison gperf zip unzip make

      - name: Run serial dependency ladder
        env:
          ICU_DATA_FILTER_FILE: ${{ github.workspace }}/icu-filter.json
        run: |
          chmod +x scripts/*.sh patches/*.sh || true
          export NPROC="${{ inputs.nproc }}"
          export RUN_LINUX_VALIDATE="${{ inputs.run_linux_validate }}"
          export REQUIRED_FINAL_STEP="${{ inputs.required_step }}"
          ./scripts/macos-dep-ladder.sh

      - name: Upload dep-ladder reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dep-ladder-reports
          path: artifacts/dep-ladder/
          if-no-files-found: warn
          retention-days: 30
