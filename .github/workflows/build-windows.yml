name: Build Windows x64

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 720

    steps:
      - uses: actions/checkout@v4

      - uses: msys2/setup-msys2@v2
        with:
          msystem: MSYS
          update: false
          install: >-
            autoconf automake bison flex gperf libtool make
            patch pkg-config zip unzip wget perl python3
            python-setuptools findutils git

      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install pkgconf for LO
        shell: msys2 {0}
        run: |
          # LO needs a Windows-native pkgconf-2.4.3.exe
          pacman -S --noconfirm mingw-w64-x86_64-pkgconf
          cp /mingw64/bin/pkgconf.exe /usr/bin/pkgconf-2.4.3.exe
          # Ensure MSYS pkgconf + pkg-config alias work for autoconf checks
          pacman -S --noconfirm pkgconf
          ls /usr/bin/pkg-config* 2>/dev/null || ln -s /usr/bin/pkgconf.exe /usr/bin/pkg-config.exe
          echo "pkg-config version: $(pkg-config --version)"
          echo "pkgconf-2.4.3 version: $(pkgconf-2.4.3 --version)"

      - run: choco install nasm -y
        shell: pwsh

      - uses: actions/cache@v4
        with:
          path: C:\msys64\home\runneradmin\.ccache
          key: ccache-win-x64-${{ hashFiles('LO_VERSION', 'distro-configs/SlimLO.conf') }}
          restore-keys: ccache-win-x64-

      - name: Build SlimLO
        shell: msys2 {0}
        env:
          CHERE_INVOKING: 1
          ICU_DATA_FILTER_FILE: /d/a/${{ github.event.repository.name }}/${{ github.event.repository.name }}/icu-filter.json
        run: |
          cd /d/a/${{ github.event.repository.name }}/${{ github.event.repository.name }}
          export PKG_CONFIG=/usr/bin/pkgconf-2.4.3.exe
          export NPROC=4
          export LO_SRC_DIR=/d/lo-src
          export OUTPUT_DIR=/d/a/${{ github.event.repository.name }}/${{ github.event.repository.name }}/output
          ./scripts/build.sh

      - uses: actions/upload-artifact@v4
        if: success()
        with:
          name: slimlo-win-x64
          path: output/
          retention-days: 30
