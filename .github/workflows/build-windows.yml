name: Build Windows x64

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 720

    steps:
      - uses: actions/checkout@v4

      - uses: msys2/setup-msys2@v2
        with:
          msystem: MSYS
          path-type: inherit
          update: false
          install: >-
            autoconf automake bison flex gperf libtool make
            patch pkg-config zip unzip wget perl python3
            python-setuptools findutils git

      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install pkgconf for LO
        shell: msys2 {0}
        run: |
          # LO (build_os=cygwin) expects a working pkgconf-2.4.3.exe
          pacman -S --noconfirm mingw-w64-x86_64-pkgconf
          mkdir -p /usr/local/bin
          ln -sf /usr/bin/cygpath /usr/local/bin/wslpath
          cat >/usr/local/bin/pkgconf-2.4.3.exe <<'EOF'
          #!/usr/bin/env bash
          export PATH="/mingw64/bin:$PATH"
          exec /mingw64/bin/pkgconf.exe "$@"
          EOF
          chmod +x /usr/local/bin/pkgconf-2.4.3.exe
          ln -sf /usr/local/bin/pkgconf-2.4.3.exe /usr/local/bin/pkg-config

          command -v pkgconf-2.4.3.exe
          pkgconf-2.4.3.exe --version
          pkgconf-2.4.3.exe --atleast-pkgconfig-version 0.9.0
          pkg-config --version
          wslpath -u D:/lo-src
          python3 --version
          command -v python.exe || true

      - run: choco install nasm -y
        shell: pwsh

      - uses: actions/cache@v4
        with:
          path: C:\msys64\home\runneradmin\.ccache
          key: ccache-win-x64-${{ hashFiles('LO_VERSION', 'distro-configs/SlimLO.conf', 'distro-configs/SlimLO-windows.conf', 'scripts/*.sh', 'patches/*.sh', 'patches/*.postautogen') }}
          restore-keys: ccache-win-x64-

      - name: Build SlimLO
        shell: msys2 {0}
        env:
          CHERE_INVOKING: 1
          MSYS: winsymlinks:native
          'ProgramFiles(x86)': C:\Program Files (x86)
          PROGRAMFILESX86: C:\Program Files (x86)
          ICU_DATA_FILTER_FILE: /d/a/${{ github.event.repository.name }}/${{ github.event.repository.name }}/icu-filter.json
          PKG_CONFIG: /usr/local/bin/pkgconf-2.4.3.exe
        run: |
          cd /d/a/${{ github.event.repository.name }}/${{ github.event.repository.name }}
          export PATH="/usr/local/bin:/mingw64/bin:$PATH"
          perl -e 'print "ProgramFiles(x86)=$ENV{\"ProgramFiles(x86)\"}\n"'
          test -f "/c/Program Files (x86)/Microsoft Visual Studio/Installer/vswhere.exe" && echo "vswhere found" || (echo "vswhere missing" && exit 1)
          vswhere="/c/Program Files (x86)/Microsoft Visual Studio/Installer/vswhere.exe"
          VS_INSTALL="$("$vswhere" -products '*' -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath | head -1)"
          test -n "$VS_INSTALL" && echo "VC tools install: $VS_INSTALL" || (echo "No VC.Tools.x86.x64 installation found" && exit 1)
          WIN_PYTHON="$(command -v python.exe || true)"
          case "$WIN_PYTHON" in
            ""|/usr/bin/*|/mingw*/*)
              for candidate in /c/hostedtoolcache/windows/Python/*/x64/python.exe /c/Python*/python.exe; do
                [ -x "$candidate" ] || continue
                WIN_PYTHON="$candidate"
                break
              done
              ;;
          esac
          [ -n "$WIN_PYTHON" ] && [ -x "$WIN_PYTHON" ] || (echo "Windows python.exe not found" && exit 1)
          export PYTHON_FOR_BUILD="$WIN_PYTHON"
          export PYTHON="$WIN_PYTHON"
          unset UCRTVersion
          "$WIN_PYTHON" --version
          echo "Using PYTHON_FOR_BUILD=$PYTHON_FOR_BUILD"
          export NPROC=4
          export LO_SRC_DIR=/d/lo-src
          export OUTPUT_DIR=/d/a/${{ github.event.repository.name }}/${{ github.event.repository.name }}/output
          ./scripts/build.sh

      - uses: actions/upload-artifact@v4
        if: success()
        with:
          name: slimlo-win-x64
          path: output/
          retention-days: 30
